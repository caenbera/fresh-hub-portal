// src/firebase/support.ts
import { collection, addDoc, serverTimestamp, updateDoc, doc } from 'firebase/firestore';
import { db } from '@/lib/firebase/config';
import type { SupportTicket } from '@/types';
import { errorEmitter } from '@/firebase/error-emitter';
import { FirestorePermissionError } from '@/firebase/errors';

type TicketCreateInput = Pick<SupportTicket, 'userId' | 'userName' | 'issueType' | 'details' | 'orderId'>;
type TicketUpdateInput = Partial<Pick<SupportTicket, 'status'>>;

export const addSupportTicket = (ticketData: TicketCreateInput) => {
  const ticketsCollection = collection(db, 'supportTickets');
  const dataWithTimestamp = {
    ...ticketData,
    status: 'new',
    createdAt: serverTimestamp(),
  };

  return addDoc(ticketsCollection, dataWithTimestamp).catch(async (serverError) => {
    const permissionError = new FirestorePermissionError({
      path: ticketsCollection.path,
      operation: 'create',
      requestResourceData: dataWithTimestamp,
    });
    errorEmitter.emit('permission-error', permissionError);
    throw serverError;
  });
};

export const updateSupportTicket = (ticketId: string, data: TicketUpdateInput) => {
  const ticketDoc = doc(db, 'supportTickets', ticketId);
  return updateDoc(ticketDoc, data).catch(async (serverError) => {
    const permissionError = new FirestorePermissionError({
      path: ticketDoc.path,
      operation: 'update',
      requestResourceData: data,
    });
    errorEmitter.emit('permission-error', permissionError);
    throw serverError;
  });
};